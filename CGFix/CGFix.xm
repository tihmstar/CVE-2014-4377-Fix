
// Logos by Dustin Howett
// See http://iphonedevwiki.net/index.php/Logos
//

#import "substrate.h"
#import <limits.h>
#import <stdlib.h>
#import <CoreGraphics/CoreGraphics.h>

void * cg_build_colorspace;
int (*_CGPDFArrayGetCount)(CGPDFArrayRef);
bool (*_CGPDFArrayGetInteger)(CGPDFArrayRef array, size_t index, CGPDFInteger *);

MSHook(void *, x_calloc, size_t times, size_t size){
    unsigned long long check;
    check = times * size;

    if (check >= UINT_MAX - 16) {
        NSLog(@"[Patch / WARNING] overflowed int to %d would cause %d Bytes allocation",(int)check,(int)check + 16);
        NSLog(@"[Patch / WARNING] exploit CVE-2014-4377 was stopped!");
        
        return NULL;
    }
    return _x_calloc(times, size);
}

//bool new_CGPDFArrayGetStream( CGPDFArrayRef array, size_t index, CGPDFStreamRef * stream)
MSHook(bool, CGPDFArrayGetStream, CGPDFArrayRef array, size_t index, CGPDFStreamRef * stream){
    unsigned long N;

    //trying to activate this check only when called by _cg_build_colorspace
    long addrDiff = ((long)__builtin_return_address(0) - (long)cg_build_colorspace);

    if (index == 3 && addrDiff < 0x1000 &&
        _CGPDFArrayGetCount(array) == 4 && _CGPDFArrayGetInteger(array,2,(CGPDFInteger *) &N) != 0 &&
        N > 0xff){
        
        NSLog(@"[Patch / WARNING] You are under attack! Attemp to exploit CVE-2014-4377 was stopped!\n");
        return 0;
    }

    return _CGPDFArrayGetStream(array, index, stream);
}

%ctor{
//    NSLog(@"[Patch] Initializing CoreGraphics patch (CVE-2014-4377)");

    //patching exploit
    MSHookFunction( (void*(*)(size_t,size_t))MSFindSymbol(MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics"), "_x_calloc"), MSHake(x_calloc));

    //prevent MobileSafari from Crashing
    cg_build_colorspace = MSFindSymbol(MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics"), "_cg_build_colorspace");
    _CGPDFArrayGetCount = (int (*)(CGPDFArrayRef))MSFindSymbol(MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics"), "_CGPDFArrayGetCount");
    _CGPDFArrayGetInteger = (bool (*)(CGPDFArrayRef, size_t, CGPDFInteger *))MSFindSymbol(MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics"), "_CGPDFArrayGetInteger");

    MSHookFunction( (bool(*)(CGPDFArrayRef, size_t, CGPDFStreamRef *))MSFindSymbol(MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics"), "_CGPDFArrayGetStream"), MSHake(CGPDFArrayGetStream));
}






