#include <stdlib.h>
#include <substrate.h>


extern "C" void *x_calloc(size_t times, size_t size);

MSHook(void *, x_calloc, size_t times, size_t size)
{
	unsigned int total;
	unsigned long long check;


    //NSLog(@"Hooking x_calloc. 1st check %lu * %lu )", times, size);
    if ((size | times) >= 0x10000)
    {
		return NULL;
    }

	total = (size * times + 31) & 0xFFFFFFF0;
	check = size * (unsigned long long)times;
	//NSLog(@"Hooking x_calloc. 3nd check (%u, %llu)", total, check);

	if  (!total < check) {
		return NULL;
	} 

    return _x_calloc(times, size);
}


/* A pointer to a function pointer that will be filled in with a stub which may be used to
   call the original implementation. This can be NULL if you do not proceed to the original.
 */
bool (*old_CGPDFArrayGetStream)(CGPDFArrayRef, size_t, CGPDFStreamRef*);
void * my_cg_build_colorspace;
int (*my_CGPDFArrayGetCount)(CGPDFArrayRef);
bool (*my_CGPDFArrayGetInteger)(CGPDFArrayRef array, size_t index, CGPDFInteger *);

/* New version of CGPDFArrayGetStream with fixes */
bool new_CGPDFArrayGetStream( CGPDFArrayRef array, size_t index, CGPDFStreamRef * stream)
{
    unsigned long N;
    if (index == 3 && 
        ((unsigned)__builtin_return_address(0) - (unsigned)my_cg_build_colorspace) < 0x1000  &&
        my_CGPDFArrayGetCount(array) == 4 &&
        my_CGPDFArrayGetInteger(array,2,(CGPDFInteger *) &N) != 0 &&
        N > 0xff){
        //NSLog(@"Hooking CGPDFArrayGetStream(%p, %lu, %p);", array, index, stream);
        //NSLog(@"CGPDFArrayGetStream return address: %p\n", __builtin_return_address(0));
        //NSLog(@"_cg_build_colorspace %p\n", MSFindSymbol(MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics"), "_cg_build_colorspace"));
        NSLog(@"You are under attack! Attemp to exploit CVE-2014-4377 was stopped!\n");
        return 0;
    }
    return old_CGPDFArrayGetStream(array, index, stream);
};


%ctor
{
	NSLog(@"[CVE-2014-4377] Initializing hooks ...\n");

	MSHookFunction((void*(*)(size_t,size_t))MSFindSymbol(MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics"), "_x_calloc"), MSHake(x_calloc));

    // Hooking CGPDFArrayGetStream. Old behaivor saved in old_CGPDFArrayGetStream */
	MSHookFunction( MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics"), "_CGPDFArrayGetStream", &new_CGPDFArrayGetStream, &old_CGPDFArrayGetStream);
    my_cg_build_colorspace = MSFindSymbol(MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics"), "_cg_build_colorspace");
    my_CGPDFArrayGetCount = (int (*)(CGPDFArrayRef))MSFindSymbol(MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics"), "_CGPDFArrayGetCount");
    my_CGPDFArrayGetInteger = (bool (*)(CGPDFArrayRef, size_t, CGPDFInteger *))MSFindSymbol(MSGetImageByName("/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics"), "_CGPDFArrayGetInteger");

	NSLog(@"[CVE-2014-4377] DONE!:\n");

}
